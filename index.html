<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ü™î ‡¶Æ‡¶æ‡¶ß‡¶¨‡¶Æ ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ ‚Äî vC5.8 (Drik‚ÜîSurya Toggle)</title>
<style>
:root{
  --bg:#fff4e3;--card:#fff8ee;--pink:#f6a9d6;--label:#4527a0;--shadow:0 6px 16px rgba(0,0,0,.12);
  --ink:#2b237c;--hi1:#e65100;--hi2:#1565c0;--blue1:#0b2257;--blue2:#183a8a;--gold:#ffe8a6;--goldink:#7a5200;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:"Noto Sans Bengali","Noto Serif Bengali",system-ui,sans-serif;color:#1a1a1a}
.wrap{max-width:460px;margin:auto;padding:8px}

/* tight (airline) */
.card{background:var(--card);border-radius:16px;padding:12px;margin:6px;box-shadow:var(--shadow)}
.title{display:flex;justify-content:space-between;align-items:center;font-weight:900;font-size:22px;margin-bottom:4px}
.line{font-size:13px;opacity:.92;text-align:center;margin:3px 0}
.line.bold{font-weight:700;color:#5a3d00}

/* toggle pill */
.toggle{display:inline-flex;align-items:center;gap:4px;background:var(--gold);color:var(--goldink);border-radius:999px;padding:4px 8px;font-size:12px;font-weight:900;cursor:pointer;border:1px solid #d9c178}
.toggle small{font-weight:700;opacity:.9}

/* blocks */
.pill{background:var(--pink);border-radius:12px;padding:10px;margin:6px 0}
.label{color:var(--label);font-weight:900;font-size:15px}
.value{font-weight:900;font-size:28px;line-height:1.25;margin-top:2px}
.sub{font-size:14px;margin-top:5px}.sub b{font-weight:900}
.paksha{display:block;text-align:center;font-weight:900;font-size:18px;margin:2px auto 4px;color:var(--goldink);background:var(--gold);border-radius:999px;padding:4px 10px;width:fit-content}
.nextTag{font-weight:900}.nextTithi{color:var(--hi1)}.nextNak{color:var(--hi2)}

.timeCol{display:flex;flex-direction:column;gap:4px;margin-top:6px}
.timeItem{background:var(--pink);border-radius:12px;padding:8px}
.timeLab{color:var(--label);font-weight:900;font-size:15px;margin-bottom:2px}
.timeVal{font-weight:900;font-size:26px;line-height:1.2}
.timeVal .ampm{font-size:22px;margin-left:2px}

.footer{font-size:13px;text-align:center;margin-top:8px;opacity:.92}

.tide{background:linear-gradient(180deg,var(--blue2),var(--blue1));color:#fff;border-radius:14px;padding:10px;margin:6px}
.thead{font-weight:900;text-align:center;margin-bottom:4px}
.tCol{display:flex;flex-direction:column;gap:4px}
.tc{background:rgba(255,255,255,.1);padding:8px;border-radius:10px}
.tLab{font-weight:800;margin-bottom:2px}
.tVal{font-weight:900;font-size:20px}
.tVal .ampm{font-size:18px}
</style>
</head>
<body>
<div class="wrap" id="root">
  <div style="text-align:center;margin-top:36px;font-weight:700">üìç ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
</div>

<script>
/* ================= Mode (persist in localStorage) ================ */
const MODE_KEY="madhabam_panchika_mode";
let MODE = localStorage.getItem(MODE_KEY) || (location.hash.match(/mode=([a-z]+)/)||[])[1] || "drik";
function setMode(m){ MODE=m; localStorage.setItem(MODE_KEY,m); }

/* ================= Utilities ================= */
const D2R=Math.PI/180,R2D=180/Math.PI, norm=x=>((x%360)+360)%360;
function fmt12(h){ if(h==null||isNaN(h)) return "‚Äî"; h=(h+24)%24; const ap=h>=12?"PM":"AM"; let hh=Math.floor(h%12); if(hh===0) hh=12; const mm=String(Math.round((h%1)*60)).padStart(2,"0"); return `${hh}:${mm} <span class="ampm">${ap}</span>`; }
function JD(y,m,d,ut=0){ if(m<=2){y--;m+=12;} const A=Math.floor(y/100),B=2-A+Math.floor(A/4); return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524.5+ut/24; }
function obliq(T){ return 23.439291-0.0130042*T; }
function gmst(J){ const T=(J-2451545)/36525; return norm(280.46061837+360.98564736629*(J-2451545)+0.000387933*T*T - T*T*T/38710000); }
function sunLong(J){ const d=J-2451545; const M=norm(357.52911+0.98560028*d); return norm(280.46646+0.98564736*d + 1.9146*Math.sin(M*D2R)+0.02*Math.sin(2*M*D2R)); }
function moonLong(J){ const d=J-2451545; const Lm=norm(218.3165+13.176358*d), D=norm(297.8501921+12.19074912*d), Ms=norm(357.5291092+0.98560028*d), Mm=norm(134.9633964+13.06499295*d); return norm(Lm + 6.289*Math.sin(Mm*D2R) + 1.274*Math.sin((2*D-Mm)*D2R) + 0.658*Math.sin(2*D*D2R) - 0.186*Math.sin(Ms*D2R)); }
function eclToEq(l,J){ const eps=obliq((J-2451545)/36525)*D2R, L=l*D2R; return {ra:norm(Math.atan2(Math.sin(L)*Math.cos(eps),Math.cos(L))*R2D)/15, dec:Math.asin(Math.sin(eps)*Math.sin(L))*R2D}; }
function hourAngle(J,ra,lat,lon,tz){ const lst=(gmst(J)/15 + tz + lon/15); let H=(lst-ra)*15; return ((H+540)%360)-180; }
function altitude(dec,H,lat){ return Math.asin(Math.sin(lat*D2R)*Math.sin(dec*D2R)+Math.cos(lat*D2R)*Math.cos(dec*D2R)*Math.cos(H*D2R))*R2D; }
function riseSet(body,J0,lat,lon,tz){ let rise=null,setv=null; for(let h=-14;h<14;h++){ const J1=J0+(h-0.5-tz)/24, J2=J0+(h+0.5-tz)/24; const L1=(body==="sun")?sunLong(J1):moonLong(J1), L2=(body==="sun")?sunLong(J2):moonLong(J2); const q1=eclToEq(L1,J1), q2=eclToEq(L2,J2); const a1=altitude(q1.dec, hourAngle(J1,q1.ra,lat,lon,tz), lat); const a2=altitude(q2.dec, hourAngle(J2,q2.ra,lat,lon,tz), lat); if(a1<0&&a2>0&&rise===null){const t=-a1/(a2-a1); rise=(h-0.5)+t;} if(a1>0&&a2<0&&setv===null){const t= a1/(a1-a2); setv=(h-0.5)+t;} } return {rise,set:setv}; }

/* ================= Panchika core ================= */
function tithiName(n){ const a=["‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶¶","‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü‡¶æ","‡¶§‡ßÉ‡¶§‡ßÄ‡ßü‡¶æ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•‡ßÄ","‡¶™‡¶û‡ßç‡¶ö‡¶Æ‡ßÄ","‡¶∑‡¶∑‡ßç‡¶†‡ßÄ","‡¶∏‡¶™‡ßç‡¶§‡¶Æ‡ßÄ","‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ‡ßÄ","‡¶®‡¶¨‡¶Æ‡ßÄ","‡¶¶‡¶∂‡¶Æ‡ßÄ","‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂‡ßÄ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶¶‡¶∂‡ßÄ","‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶ø‡¶Æ‡¶æ","‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶™‡¶¶","‡¶¶‡ßç‡¶¨‡¶ø‡¶§‡ßÄ‡ßü‡¶æ","‡¶§‡ßÉ‡¶§‡ßÄ‡ßü‡¶æ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶•‡ßÄ","‡¶™‡¶û‡ßç‡¶ö‡¶Æ‡ßÄ","‡¶∑‡¶∑‡ßç‡¶†‡ßÄ","‡¶∏‡¶™‡ßç‡¶§‡¶Æ‡ßÄ","‡¶Ö‡¶∑‡ßç‡¶ü‡¶Æ‡ßÄ","‡¶®‡¶¨‡¶Æ‡ßÄ","‡¶¶‡¶∂‡¶Æ‡ßÄ","‡¶è‡¶ï‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶¶‡ßç‡¶¨‡¶æ‡¶¶‡¶∂‡ßÄ","‡¶§‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶¶‡¶∂‡ßÄ","‡¶ö‡¶§‡ßÅ‡¶∞‡ßç‡¶¶‡¶∂‡ßÄ","‡¶Ö‡¶Æ‡¶æ‡¶¨‡¶∏‡ßç‡¶Ø‡¶æ"]; return a[(n-1)%30]; }
const NAK=["‡¶Ö‡¶∂‡ßç‡¶¨‡¶ø‡¶®‡ßÄ","‡¶≠‡¶∞‡¶£‡ßÄ","‡¶ï‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï‡¶æ","‡¶∞‡ßã‡¶π‡¶ø‡¶£‡ßÄ","‡¶Æ‡ßÉ‡¶ó‡¶∂‡¶ø‡¶∞‡¶æ","‡¶Ü‡¶¶‡ßç‡¶∞‡¶æ","‡¶™‡ßÅ‡¶®‡¶∞‡ßç‡¶¨‡¶∏‡ßÇ","‡¶™‡ßÅ‡¶∑‡ßç‡¶Ø‡¶æ","‡¶Ü‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶æ","‡¶Æ‡¶ò‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ","‡¶π‡¶∏‡ßç‡¶§‡¶æ","‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ","‡¶∏‡ßç‡¶¨‡¶æ‡¶§‡ßÄ","‡¶¨‡¶ø‡¶∂‡¶æ‡¶ñ‡¶æ","‡¶Ö‡¶®‡ßÅ‡¶∞‡¶æ‡¶ß‡¶æ","‡¶ú‡ßç‡¶Ø‡ßá‡¶∑‡ßç‡¶†‡¶æ","‡¶Æ‡ßÇ‡¶≤‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶∑‡¶æ‡ßù‡¶æ","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶∑‡¶æ‡ßù‡¶æ","‡¶∂‡ßç‡¶∞‡¶¨‡¶£‡¶æ","‡¶ß‡¶®‡¶ø‡¶∑‡ßç‡¶†‡¶æ","‡¶∂‡¶§‡¶≠‡¶ø‡¶∑‡¶æ","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶","‡¶∞‡ßá‡¶¨‡¶§‡ßÄ"];
const LORD={"‡¶Ö‡¶∂‡ßç‡¶¨‡¶ø‡¶®‡ßÄ":"‡¶ï‡ßá‡¶§‡ßÅ (Ketu)","‡¶≠‡¶∞‡¶£‡ßÄ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞ (Venus)","‡¶ï‡ßÉ‡¶§‡ßç‡¶§‡¶ø‡¶ï‡¶æ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø (Sun)","‡¶∞‡ßã‡¶π‡¶ø‡¶£‡ßÄ":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ (Moon)","‡¶Æ‡ßÉ‡¶ó‡¶∂‡¶ø‡¶∞‡¶æ":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ (Mars)","‡¶Ü‡¶¶‡ßç‡¶∞‡¶æ":"‡¶∞‡¶æ‡¶π‡ßÅ (Rahu)","‡¶™‡ßÅ‡¶®‡¶∞‡ßç‡¶¨‡¶∏‡ßÇ":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø (Jupiter)","‡¶™‡ßÅ‡¶∑‡ßç‡¶Ø‡¶æ":"‡¶∂‡¶®‡¶ø (Saturn)","‡¶Ü‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶æ":"‡¶¨‡ßÅ‡¶ß (Mercury)","‡¶Æ‡¶ò‡¶æ":"‡¶ï‡ßá‡¶§‡ßÅ (Ketu)","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞ (Venus)","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®‡ßÄ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø (Sun)","‡¶π‡¶∏‡ßç‡¶§‡¶æ":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ (Moon)","‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶æ":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ (Mars)","‡¶∏‡ßç‡¶¨‡¶æ‡¶§‡ßÄ":"‡¶∞‡¶æ‡¶π‡ßÅ (Rahu)","‡¶¨‡¶ø‡¶∂‡¶æ‡¶ñ‡¶æ":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø (Jupiter)","‡¶Ö‡¶®‡ßÅ‡¶∞‡¶æ‡¶ß‡¶æ":"‡¶∂‡¶®‡¶ø (Saturn)","‡¶ú‡ßç‡¶Ø‡ßá‡¶∑‡ßç‡¶†‡¶æ":"‡¶¨‡ßÅ‡¶ß (Mercury)","‡¶Æ‡ßÇ‡¶≤‡¶æ":"‡¶ï‡ßá‡¶§‡ßÅ (Ketu)","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶∑‡¶æ‡ßù‡¶æ":"‡¶∂‡ßÅ‡¶ï‡ßç‡¶∞ (Venus)","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶∑‡¶æ‡ßù‡¶æ":"‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø (Sun)","‡¶∂‡ßç‡¶∞‡¶¨‡¶£‡¶æ":"‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ (Moon)","‡¶ß‡¶®‡¶ø‡¶∑‡ßç‡¶†‡¶æ":"‡¶Æ‡¶ô‡ßç‡¶ó‡¶≤ (Mars)","‡¶∂‡¶§‡¶≠‡¶ø‡¶∑‡¶æ":"‡¶∞‡¶æ‡¶π‡ßÅ (Rahu)","‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶":"‡¶¨‡ßÉ‡¶π‡¶∏‡ßç‡¶™‡¶§‡¶ø (Jupiter)","‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶≠‡¶æ‡¶¶‡ßç‡¶∞‡¶™‡¶¶":"‡¶∂‡¶®‡¶ø (Saturn)","‡¶∞‡ßá‡¶¨‡¶§‡ßÄ":"‡¶¨‡ßÅ‡¶ß"};

/* Surya calc */
function tithiInfo(J){ const ls=sunLong(J), lm=moonLong(J); const diff=norm(lm-ls); const num=Math.floor(diff/12)+1; const rem=(diff%12)/12; const paksha=(num<=15)?"‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑":"‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑"; return {num,rem,paksha}; }
function nakInfo(J){ const lm=moonLong(J), step=(13+20/60); const idx=Math.floor(lm/step); const frac=(lm%step)/step; return {idx,frac,name:NAK[idx]}; }

/* Simple Bangabda (sunrise-based) */
function lahiriAyanamsa(J){ return 24.0; }
const B_MONTHS=["‡¶¨‡ßà‡¶∂‡¶æ‡¶ñ","‡¶ú‡ßç‡¶Ø‡ßà‡¶∑‡ßç‡¶†","‡¶Ü‡¶∑‡¶æ‡ßù","‡¶∂‡ßç‡¶∞‡¶æ‡¶¨‡¶£","‡¶≠‡¶æ‡¶¶‡ßç‡¶∞","‡¶Ü‡¶∂‡ßç‡¶¨‡¶ø‡¶®","‡¶ï‡¶æ‡¶∞‡ßç‡¶§‡¶ø‡¶ï","‡¶Ö‡¶ó‡ßç‡¶∞‡¶π‡¶æ‡ßü‡¶£","‡¶™‡ßå‡¶∑","‡¶Æ‡¶æ‡¶ò","‡¶´‡¶æ‡¶≤‡ßç‡¶ó‡ßÅ‡¶®","‡¶ö‡ßà‡¶§‡ßç‡¶∞"];
function bangabdaFromSun(J, localDate){ const ay=lahiriAyanamsa(J); const lon=norm(sunLong(J)-ay); const sign=Math.floor(lon/30); const dayInMonth=Math.floor(lon%30)+1; const poila=new Date(localDate.getFullYear(),3,14); const byear=(localDate>=poila)?(localDate.getFullYear()-593):(localDate.getFullYear()-594); return {month:B_MONTHS[sign], day:dayInMonth, year:byear}; }

/* ================= Location (GPS ‚Üí IP ‚Üí BDC ‚Üí fallback) ================= */
const FALLBACK={lat:22.5726,lon:88.3639,tz:(-new Date().getTimezoneOffset()/60),place:"Kolkata, India",city:"Kolkata"};
async function reverseNom(lat,lon){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10`);const j=await r.json();if(j?.address){const a=j.address, city=a.city||a.town||a.village||a.county||a.state||""; const country=a.country||""; return {place:city?`${city}, ${country}`:country, city:city||country||"Unknown"} }}catch{} return {place:"",city:""}}
async function reverseBDC(lat,lon){try{const r=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);const j=await r.json(); if(j){const city=j.city||j.locality||j.principalSubdivision||""; const country=j.countryName||""; return {place:city?`${city}, ${country}`:country, city:city||country||"Unknown"} }}catch{} return {place:"",city:""}}
async function getLocation(){
  if(navigator.geolocation){
    const got=await new Promise(res=>{navigator.geolocation.getCurrentPosition(async p=>{const lat=p.coords.latitude,lon=p.coords.longitude;let geo=await reverseNom(lat,lon); if(!geo.place) geo=await reverseBDC(lat,lon); res({lat,lon,tz:(-new Date().getTimezoneOffset()/60),place:geo.place||"GPS",city:geo.city||"GPS"});},()=>res(null),{timeout:6000})});
    if(got) return got;
  }
  try{const r=await fetch("https://ipapi.co/json/");const j=await r.json(); if(j?.latitude){let geo=await reverseNom(j.latitude,j.longitude); if(!geo.place) geo=await reverseBDC(j.latitude,j.longitude); return {lat:j.latitude,lon:j.longitude,tz:(-new Date().getTimezoneOffset()/60),place:geo.place||(j.city?`${j.city}, ${j.country_name}`:""),city:geo.city||j.city||"IP"} }}catch{}
  try{const r=await fetch("https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=&longitude=&localityLanguage=en");const j=await r.json(); if(j?.latitude){const city=j.city||j.locality||j.principalSubdivision||""; const country=j.countryName||""; return {lat:j.latitude,lon:j.longitude,tz:(-new Date().getTimezoneOffset()/60),place:city?`${city}, ${country}`:country,city:city||country||"IP"} }}catch{}
  return FALLBACK;
}

/* ================= Drik-style correction (keyless, lightweight) =================
   ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ: ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø/‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßá‡¶∞ mean longitude-‡¶è ‡¶õ‡ßã‡¶ü ŒîŒª ‡¶Ø‡ßã‡¶ó/‡¶¨‡¶ø‡¶Ø‡¶º‡ßã‡¶ó ‚Äî API ‡¶õ‡¶æ‡ßú‡¶æ‡•§
   ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶¨ ‡¶≤‡¶æ‡¶á‡¶ü ‡¶π‡¶ø‡¶â‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶ø‡¶ï correction ‡¶¶‡¶ø‡¶≤‡¶æ‡¶Æ (‚âà minute-level tune)‡•§
   ‡¶≠‡¶¨‡¶ø‡¶∑‡ßç‡¶Ø‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá /data/corr.json ‡¶•‡ßá‡¶ï‡ßá finer table ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡ßá ‡¶¨‡¶∏‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‚Äî ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶è‡¶ñ‡¶® ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§
*/
function drikCorrectedLongitudes(J){
  // seasonal tiny correction ~¬±0.8¬∞ for moon, ~¬±0.3¬∞ for sun (heuristic wave)
  const d=J-2451545;
  const sun = sunLong(J) + 0.25*Math.sin((2*Math.PI/365.2425)*d);
  const moon = moonLong(J) + 0.8*Math.sin((2*Math.PI/27.55454988)*d);
  return {sun:norm(sun), moon:norm(moon)};
}
function tithiInfoDrik(J){
  const L=drikCorrectedLongitudes(J); const diff=norm(L.moon-L.sun);
  const num=Math.floor(diff/12)+1; const rem=(diff%12)/12;
  const paksha=(num<=15)?"‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑":"‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑"; return {num,rem,paksha};
}
function nakInfoDrik(J){
  const L=drikCorrectedLongitudes(J).moon; const step=(13+20/60); const idx=Math.floor(L/step); const frac=(L%step)/step;
  return {idx,frac,name:NAK[idx]};
}

/* ================= Tide (approx) ================= */
function tideApprox(lon){ const high1=(5 + (lon/15))%24, high2=(high1 + 12.42)%24, low1=(high1 + 6.21)%24, low2=(high2 + 6.21)%24; return {high1,high2,low1,low2}; }

/* ================= Render ================= */
const root=()=>document.getElementById("root");

(async function init(){
  const loc=await getLocation();
  const {lat,lon,tz,place,city}=loc;

  const now=new Date();
  const ist=new Date(now.toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
  const Y=ist.getFullYear(),M=ist.getMonth()+1,D=ist.getDate();

  // JD & sunrise-based day
  const J0=JD(Y,M,D,0);
  const rs0=riseSet("sun",J0,lat,lon,tz);
  const localHr=now.getHours()+now.getMinutes()/60;
  const srHrLocal=rs0.rise!=null?(rs0.rise+12+tz):6;
  const Jp=(localHr<srHrLocal)?(J0-1):J0;

  // evaluate a little after sunrise for "day-valid"
  const evalHr = srHrLocal + 0.5;
  const JEval = Jp + (evalHr - tz)/24;

  // choose engine
  const t = (MODE==="drik") ? tithiInfoDrik(JEval) : tithiInfo(JEval);
  const n = (MODE==="drik") ? nakInfoDrik(JEval)   : nakInfo(JEval);

  const tNext = tithiName((t.num%30)+1);
  const nNext = NAK[(n.idx+1)%27];

  const tEnd=fmt12(localHr + (12*(1 - t.rem))/(13.176358 - 0.98564736)*24);
  const nEnd=fmt12(localHr + ((13 + 20/60) * (1 - n.frac)) / 13.176358 * 24);

  // events (same for both)
  const rsS=riseSet("sun",Jp,lat,lon,tz), rsM=riseSet("moon",Jp,lat,lon,tz);
  const sr=fmt12(rsS.rise+12+tz), ss=fmt12(rsS.set+12+tz);
  const mr=(rsM.rise!=null)?fmt12(rsM.rise+12+tz):"‚Äî", ms=(rsM.set!=null)?fmt12(rsM.set+12+tz):"‚Äî";

  // Bangabda (sunrise-based display)
  const bang=bangabdaFromSun(JEval, ist);

  // tide
  const td=tideApprox(lon);

  const label = (MODE==="drik")? "‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞: ‡¶¶‡ßÉ‡¶ï (Govt-style)" : "‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞: ‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ (Calc)";

  root().innerHTML=`
  <section class="card">
    <div class="title">
      <span>ü™î ‡¶™‡¶û‡ßç‡¶ú‡¶ø‡¶ï‡¶æ</span>
      <span class="toggle" id="tg">${label} <small>‚áÑ</small></span>
    </div>
    <div class="line">‡¶Ü‡¶ú: ${bang.day} ${bang.month} ${bang.year} ‡¶¨‡¶ô‡ßç‡¶ó‡¶æ‡¶¨‡ßç‡¶¶</div>
    <div class="line bold">üìç ${place||city}</div>
    <div class="line" id="lt"></div>

    <div class="pill">
      <span class="paksha">${t.paksha}</span>
      <div class="label">‡¶§‡¶ø‡¶•‡¶ø</div>
      <div class="value">${tithiName(t.num)}</div>
      <div class="sub"><b>‡¶∂‡ßá‡¶∑:</b> ${tEnd} &nbsp;‚Ä¢&nbsp; <b>‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ:</b> <span class="nextTag nextTithi">${tNext}</span></div>
    </div>

    <div class="pill">
      <div class="label">‡¶®‡¶ï‡ßç‡¶∑‡¶§‡ßç‡¶∞</div>
      <div class="value">${n.name}</div>
      <div class="sub" style="color:var(--ink);font-weight:800">‡¶Ö‡¶ß‡¶ø‡¶™‡¶§‡¶ø ‡¶ó‡ßç‡¶∞‡¶π: ${LORD[n.name]||"‚Äî"}</div>
      <div class="sub"><b>‡¶∂‡ßá‡¶∑:</b> ${nEnd} &nbsp;‚Ä¢&nbsp; <b>‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ:</b> <span class="nextTag nextNak">${nNext}</span></div>
    </div>

    <div class="timeCol">
      <div class="timeItem"><div class="timeLab">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡ßã‡¶¶‡¶Ø‡¶º</div><div class="timeVal">${sr}</div></div>
      <div class="timeItem"><div class="timeLab">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶æ‡¶∏‡ßç‡¶§</div><div class="timeVal">${ss}</div></div>
      <div class="timeItem"><div class="timeLab">‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßã‡¶¶‡¶Ø‡¶º</div><div class="timeVal">${mr}</div></div>
      <div class="timeItem"><div class="timeLab">‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡ßç‡¶§</div><div class="timeVal">${ms}</div></div>
    </div>

    <div class="footer">Latitude ${lat.toFixed(2)}¬∞, Longitude ${lon.toFixed(2)}¬∞</div>
    <div class="footer">‡¶∏‡ßÇ‡¶∞‡ßç‡¶Ø‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ó‡¶£‡¶®‡¶æ</div>
  </section>

  <section class="tide">
    <div class="thead">üåä ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ú‡ßã‡¶Ø‡¶º‡¶æ‡¶∞-‡¶≠‡¶æ‡¶ü‡¶æ (‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï, ‡¶Ü‡¶®‡ßÅ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï)</div>
    <div class="tCol">
      <div class="tc"><div class="tLab">‡¶â‡¶ö‡ßç‡¶ö ‡¶ú‡ßã‡¶Ø‡¶º‡¶æ‡¶∞ ‡ßß</div><div class="tVal">${fmt12(td.high1)}</div></div>
      <div class="tc"><div class="tLab">‡¶â‡¶ö‡ßç‡¶ö ‡¶ú‡ßã‡¶Ø‡¶º‡¶æ‡¶∞ ‡ß®</div><div class="tVal">${fmt12(td.high2)}</div></div>
      <div class="tc"><div class="tLab">‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶≠‡¶æ‡¶ü‡¶æ ‡ßß</div><div class="tVal">${fmt12(td.low1)}</div></div>
      <div class="tc"><div class="tLab">‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶≠‡¶æ‡¶ü‡¶æ ‡ß®</div><div class="tVal">${fmt12(td.low2)}</div></div>
    </div>
  </section>
  `;

  // local time
  const tzFmt=new Intl.DateTimeFormat('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true,timeZoneName:'short'});
  document.getElementById('lt').textContent="‚è∞ Local Time ‚Äî " + tzFmt.format(ist);

  // toggle handler
  document.getElementById('tg').onclick=()=>{ setMode(MODE==="drik"?"surya":"drik"); location.reload(); };
})();
</script>
</body>
</html>
